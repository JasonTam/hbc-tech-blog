<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>OSX, Docker, NFS and packet filter firewall</title><title>OSX, Docker, NFS and packet filter firewall | HBC Tech</title><meta property="og:title" content="OSX, Docker, NFS and packet filter firewall"><meta name="author" content="Andrey Kartashov"><meta property="og:locale" content="en_US"><meta name="description" content="The Mobile Services team at Gilt uses Docker to both build and run software. In addition to the usual Docker benefits for software deployments moving toolchains to Docker has a few advantages:"><meta property="og:description" content="The Mobile Services team at Gilt uses Docker to both build and run software. In addition to the usual Docker benefits for software deployments moving toolchains to Docker has a few advantages:"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/docker/2016/03/10/osx-docker-firewall/"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/docker/2016/03/10/osx-docker-firewall/"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-03-10T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Andrey Kartashov"><script type="application/ld+json">{"name":null,"description":"The Mobile Services team at Gilt uses Docker to both build and run software. In addition to the usual Docker benefits for software deployments moving toolchains to Docker has a few advantages:","author":{"@type":"Person","name":"Andrey Kartashov"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/docker/2016/03/10/osx-docker-firewall/","publisher":null,"image":null,"headline":"OSX, Docker, NFS and packet filter firewall","dateModified":"2016-03-10T00:00:00-05:00","datePublished":"2016-03-10T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/docker/2016/03/10/osx-docker-firewall/"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/docker/2016/03/10/osx-docker-firewall/"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body class="container" aria-label="Content"><header id="site-header" class="site-header"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#docker" class="meta__category">docker</a> <span class="meta__title">OSX, Docker, NFS and packet filter firewall</span></p><ul class="navigation"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul></header><section class="content"><article class="article"><section class="article__no-feature-image"></section><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#docker" class="article-meta__category">docker</a> <span class="article-meta__date">Published 10 MAR 2016</span></div><h1 class="article__content__title" title="OSX, Docker, NFS and packet filter firewall">OSX, Docker, NFS and packet filter firewall</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">4 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//docker/2016/03/10/osx-docker-firewall/" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/docker/2016/03/10/osx-docker-firewall/&title=OSX, Docker, NFS and packet filter firewall" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//docker/2016/03/10/osx-docker-firewall/" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//docker/2016/03/10/osx-docker-firewall/" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><p>The Mobile Services team at Gilt uses Docker to both build and run software. In addition to the usual Docker benefits for software deployments moving toolchains to Docker has a few advantages:</p><ul><li>it’s easy to (re)create a development environment</li><li>the environment is preserved in a stable binary form (libs, configs, CLI tools, etc, etc don’t bit rot as main OS packages or OS itself evolve)</li><li>easy to support multiple divergent environments where different versions of tools/libs are the default; e.g. java7/8, python, ruby, scala, etc</li></ul><p>We develop primarily on OSX, but since Docker is a Linux-specific tool, we must use docker-machine and VirtualBox to actually run it. Toolchains rely on having access to the host OS’s filesystem. By default <code class="highlighter-rouge">/Users</code> is exposed in the Docker VM. Unfortunately, the default setup uses VBOXFS which is very slow. This can be really painful when building larger projects or relying on build steps that require a lot of IO, such as the <a href="https://github.com/sbt/sbt-assembly">sbt-assembly</a> plugin.</p><p>Here’s a great <a href="http://mitchellh.com/comparing-filesystem-performance-in-virtual-machines">comparison of IO performance</a>.</p><p>There’s really no good solution for this problem at the moment, but some folks have come up with a reasonable hack: use NFS.</p><p>One of them was even nice enough to wrap it up into a <a href="https://github.com/adlogix/docker-machine-nfs">shell script</a> that “just works”.</p><p>Indeed, with NFS enabled, project build times begin to approach “native” speeds, so it’s tempting. The issue with NFS continues to be its aging design and intent to function in trusted network environment where access is given to hosts, not to authenticated users. While this is a reasonable access model for secure production networks, it’s hard to guarantee anything about random networks you may have to connect to with your laptop, and having <code class="highlighter-rouge">/Users</code> exposed via NFS on un-trusted networks is a scary prospect.</p><p>OSX has not one but two built-in firewalls. There’s a simplified app-centric firewall available from Preferences panel. Unfortunately all it can do is either block all NFS traffic (docker VM can’t access your exported file system) or open up NFS traffic on all interfaces (insecure), so it doesn’t really work for this case.</p><p>Fortunately, under the hood there’s also a much more flexible built-in packet level firewall that can be configured. It’s called PF (packet filter) and its main CLI tool is pfctl. Here’s a nice <a href="https://pleiades.ucsc.edu/hyades/PF_on_Mac_OS_X">intro</a>.</p><p>With that, one possible solution is to disable firewall in the Preferences panel and add this section at the end of the <code class="highlighter-rouge">/etc/pf.conf</code> file instead:</p><div class="highlighter-rouge"><pre class="highlight"><code># Do not filter anything on private interfaces
set skip on lo0
set skip on vboxnet0
set skip on vboxnet1

# Allow all traffic between host and docker VM
table &lt;docker&gt; const { 192.168.99/24 }
docker_if = "{" bridge0  vboxnet0  vboxnet1 "}"
pass quick on $docker_if inet proto icmp from &lt;docker&gt; to &lt;docker&gt;
pass quick on $docker_if inet proto udp from &lt;docker&gt; to &lt;docker&gt; keep state
pass quick on $docker_if inet proto tcp from &lt;docker&gt; to &lt;docker&gt; keep state

# Allow icmp
pass in quick inet  proto icmp
pass in quick inet6 proto ipv6-icmp

# Bonjour
pass in quick proto udp from any to any port 5353

# DHCP Client
pass in quick proto udp from any to any port 68

# Block all incoming traffic by default
block drop in
pass out quick
</code></pre></div><p>Then turn it on at a system boot time by adding /Library/LaunchDaemons/com.yourcompany.pfctl.plist</p><div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
	<span class="nt">&lt;key&gt;</span>Disabled<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;false/&gt;</span>
	<span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>com.gilt.pfctl<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>WorkingDirectory<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>/var/run<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>Program<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;string&gt;</span>/sbin/pfctl<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;array&gt;</span>
		<span class="nt">&lt;string&gt;</span>pfctl<span class="nt">&lt;/string&gt;</span>
		<span class="nt">&lt;string&gt;</span>-E<span class="nt">&lt;/string&gt;</span>
		<span class="nt">&lt;string&gt;</span>-f<span class="nt">&lt;/string&gt;</span>
		<span class="nt">&lt;string&gt;</span>/etc/pf.conf<span class="nt">&lt;/string&gt;</span>
	<span class="nt">&lt;/array&gt;</span>
	<span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
	<span class="nt">&lt;true/&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</code></pre></div><p>And configuring it to start by running</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo launchctl load -w /Library/LaunchDaemons/com.yourcompany.pfctl.plist
</code></pre></div><p>The main difference from /System/Library/LaunchDaemons/com.apple.pfctl.plist here is the addition of -E parameter.</p><p>You can check that it starts by default after a reboot with</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo pfctl -s info
</code></pre></div><p>And check the rules with</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo pfctl -s rules
</code></pre></div><p>It should be ‘Enabled’ and you should see the configured rules.</p><p>You can verify your overall setup by running nmap from a different node against your laptop, e.g.</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo nmap -P0 -sU  YOUR_IP
sudo nmap -P0 -sT  YOUR_IP
</code></pre></div><p>And check for open ports.</p><p>After that configuration you should see a noticeable improvement in docker performance for file system intensive workloads. Hopefully this will no longer be necessary in future versions of Docker VM so check the docs to be sure.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">docker</span><span>,</span> <span class="article-tags__tag">osx</span><span>,</span> <span class="article-tags__tag">nfs</span><span>,</span> <span class="article-tags__tag">firewall</span></div><section class="author"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Andrey Kartashov</span></section></footer></section></article><aside class="recirc"><h2 class="header__title">More Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">Explore Categories</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree">Dublin Scala Spree</a></h1><div class="snippet__meta"><span class="meta__day">11</span> <span class="meta__month">SEP</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#open source">open source</a>Gregor Heine</div><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree"><p class="snippet__excerpt">Dublin Scala Spree This Friday the Gilt/HBC Digital Dublin office will be hosting the first ever Dublin Scala Spree, a day-long Scala Open Source Hackathon. The event is organized by the Dublin Scala Usergroup in cooperation with Dublin Functional Kubs and the Scala Center at EPFL in Lausanne, Switzerland. Date &amp; Time: Friday, 15th September, 10am - 4pm Location: Gilt/HBC Digital Office, Shelbourne Rd., Dublin 4, Ireland Sign-Up: Please register...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017">HBC Tech Talks: February 2017 through July 2017</a></h1><div class="snippet__meta"><span class="meta__day">10</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/conferences">conferences</a><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/hbc-tech">HBC Tech</a></div><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017"><p class="snippet__excerpt">We’ve had a busy 2017 at HBC. The great work of our teams has created opportunities to share what we’ve learned with audiences around the world. This year our folks have been on stage in Austin, Sydney, Portland, Seattle, San Diego, Boston, London, Israel and on our home turf in NYC and Dublin. The talks have covered deep learning, design thinking, data streaming and developer experience to name just a...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?">Sundial or AWS Batch, Why not both?</a></h1><div class="snippet__meta"><span class="meta__day">4</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#data">data</a>Kevin O'Riordan</div><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?"><p class="snippet__excerpt">About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/07/31/tiefvision-2/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/07/31/tiefvision-2/" class="snippet__link" title="Visually Similar Recommendations">Visually Similar Recommendations</a></h1><div class="snippet__meta"><span class="meta__day">31</span> <span class="meta__month">JUL</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#personalization">personalization</a>Chris Curro</div><a href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/07/31/tiefvision-2/" class="snippet__link" title="Visually Similar Recommendations"><p class="snippet__excerpt"></p></a></section></article></div></aside></section><footer class="footer"><svg class="hbc-stripes-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-stripes-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-stripes-logo"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><ul class="navigation navigation--footer"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script></body></html>