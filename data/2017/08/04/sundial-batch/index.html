<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Sundial or AWS Batch, Why not both?</title><title>Sundial or AWS Batch, Why not both? | HBC Tech</title><meta property="og:title" content="Sundial or AWS Batch, Why not both?"><meta name="author" content="Kevin O'Riordan"><meta property="og:locale" content="en_US"><meta name="description" content="About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service."><meta property="og:description" content="About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service."><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-08-04T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Kevin O'Riordan"><script type="application/ld+json">{"name":null,"description":"About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service.","author":{"@type":"Person","name":"Kevin O'Riordan"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/","publisher":null,"image":null,"headline":"Sundial or AWS Batch, Why not both?","dateModified":"2017-08-04T00:00:00-05:00","datePublished":"2017-08-04T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body class="container" aria-label="Content"><header id="site-header" class="site-header site-header--scaled"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-stripes-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-stripe hbc-stripe--green" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-green"></use><use class="hbc-stripe hbc-stripe--red" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-red"></use><use class="hbc-stripe hbc-stripe--yellow" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-yellow"></use><use class="hbc-stripe hbc-stripe--blue" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-blue"></use><use class="hbc-stripes-logo--text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#text"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#data" class="meta__category">data</a> <span class="meta__title">Sundial or AWS Batch, Why not both?</span></p><ul class="navigation"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/about" class="navigation__link"><span class="navigation__link-highlight">About</span></a></li></ul></header><section class="content"><article class="article"><section class="article__no-feature-image"></section><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#data" class="article-meta__category">data</a> <span class="article-meta__date">Published 4 AUG 2017</span></div><h1 class="article__content__title" title="Sundial or AWS Batch, Why not both?">Sundial or AWS Batch, Why not both?</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">3 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//data/2017/08/04/sundial-batch/" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/data/2017/08/04/sundial-batch/&title=Sundial or AWS Batch, Why not both?" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//data/2017/08/04/sundial-batch/" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//data/2017/08/04/sundial-batch/" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><p>About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial <img src="https://github.com/gilt/sundial">, a batch job orchestration system leveraging <a href="https://aws.amazon.com/ecs/">Amazon EC2 Container Service</a>.</p><p>We built Sundial to provide the following features on top of the standard ECS setup:</p><ul><li>Streaming Logs (to Cloudwatch and S3 and live in Sundial UI)</li><li>Metadata collection (through Graphite and displayed live in Sundial UI)</li><li>Dependency management between jobs</li><li>Retry strategies for failed jobs</li><li>Cron style scheduling for jobs</li><li>Email status reporting for jobs</li><li>Pagerduty integration for notifying team members about failing critical jobs</li></ul><p><a href="http://i.imgur.com/RUZHLdI.png" title="Sundial DAG">Sundial DAG</a></p><p>Other solutions available at the time didn’t suit our needs. Solutions we considered included <a href="https://mesos.github.io/chronos/">Chronos</a> which lacked the features we needed and required a Mesos cluster, <a href="https://github.com/spotify/luigi">Spotify Luigi</a> and <a href="http://airbnb.io/projects/airflow/">Airbnb Airflow</a>, which was immature at the time.</p><p>At the time, we chose ECS because we hoped to take advantages of AWS features such as autoscaling in order to save costs by scaling the cluster up and down by demand. In practice, this required too much manual effort and moving parts so we lived with a long running cluster scaled to handle peak load.</p><p>Since then, our needs have grown and we have jobs ranging in size from a couple of hundred MB of memory to 60GB of memory. Having a cluster scaled to handle peak load with all these job sizes had become too expensive. Most job failure noise has been due to cluster resources not being available or smaller jobs taking up space on instances meant to be dedicated to bigger jobs. (ECS is weak when it comes to task placement strategies).</p><p>Thankfully AWS have come along with their own enhancements on top of ECS in the form of <a href="https://aws.amazon.com/batch/">AWS Batch</a>.</p><h3 id="what-we-love-about-batch">What we love about Batch</h3><ul><li>Managed compute environment. This means AWS handles scaling up and down the cluster in response to workload.</li><li>Heterogenous instance types (useful when we have outlier jobs taking large amounts of CPU/memory resources)</li><li>Spot instances (save over half on on-demand instance costs)</li><li>Easy integration with Cloudwatch Logs (stdout and stderr captured automatically)</li></ul><h3 id="what-sucks">What sucks</h3><ul><li>Not being able to run “linked” containers (We relied on this for metadata service and log upload to S3)</li><li>Needing a custom AMI to configure extra disk space on the instances.</li></ul><h3 id="what-wed-love-for-batch-to-do-better">What we’d love for Batch to do better</h3><ul><li>Make disk space on managed instances configurable. Currently the workaround is to create a custom AMI with the disk space you need if you have jobs that store a lot of data on disk (Not uncommon in a data processing environment). Gilt has a feature request open with Amazon on this issue.</li></ul><h3 id="why-not-dump-sundial-in-favour-of-using-batch-directly">Why not dump Sundial in favour of using Batch directly?</h3><p>Sundial still provides features that Batch doesn’t provide:</p><ul><li>Email reporting</li><li>Pagerduty integration</li><li>Easy transition, processes can be a mixed workload of jobs running on ECS and Batch.</li><li>Configurable backoff strategy for job retries.</li><li>Time limits for jobs. If a job hangs, we can kill and retry after a certain period of time</li><li>Nice dashboard of processes (At a glance see what’s green and what’s red)</li></ul><p><img src="http://i.imgur.com/PAeqBJH.png" alt="alt text" title="Sundial dashboard"></p><p>Sure enough, some of the above can be configured through hooking up lambdas/SNS messages etc. but Sundial gives it to you out of the box.</p><h3 id="what-next">What next?</h3><p>Sundial with AWS Batch backend now works great for the use cases we encounter doing personalization. We may consider enhancements such as Prometheus push gateway integration (to replace the Graphite service we had with ECS and to keep track of metrics over time) and UI enhancements to Sundial.</p><p>In the long term we may consider other open source solutions as maintaining a job system counts as technical debt that is a distraction from product focused tasks. The HBC data team, who have very similar requirements to us, have started adopting Airflow (by Airbnb). As part of their adoption, they have contributed to an open source effort to make Airflow support Batch as a backend: <a href="https://github.com/gilt/incubator-airflow/tree/aws_batch">https://github.com/gilt/incubator-airflow/tree/aws_batch</a>. If it works well, this is a solution we may adopt in the future.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">batch</span><span>,</span> <span class="article-tags__tag">aws</span><span>,</span> <span class="article-tags__tag">tech</span><span>,</span> <span class="article-tags__tag">personalization</span></div><section class="author-bio"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Kevin O'Riordan</span></section></footer></section></article><aside class="recirc"><h2 class="header__title">Recent Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">See All</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree">Dublin Scala Spree</a></h1><div class="snippet__meta"><span class="meta__day">11</span> <span class="meta__month">SEP</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#open source">open source</a> <span class="slug-divider"></span> <span class="meta__author">Gregor Heine</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree"><p class="snippet__excerpt">Dublin Scala Spree This Friday the Gilt/HBC Digital Dublin office will be hosting the first ever Dublin Scala Spree, a day-long Scala Open Source Hackathon. The event is organized by the Dublin Scala Usergroup in cooperation with Dublin Functional Kubs and the Scala Center at EPFL in Lausanne, Switzerland. Date &amp; Time: Friday, 15th September, 10am - 4pm Location: Gilt/HBC Digital Office, Shelbourne Rd., Dublin 4, Ireland Sign-Up: Please register...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017">HBC Tech Talks: February 2017 through July 2017</a></h1><div class="snippet__meta"><span class="meta__day">10</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/conferences">conferences</a> <span class="slug-divider"></span> <span class="meta__author"><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/hbc-tech">HBC Tech</a></span></div><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017"><p class="snippet__excerpt">We’ve had a busy 2017 at HBC. The great work of our teams has created opportunities to share what we’ve learned with audiences around the world. This year our folks have been on stage in Austin, Sydney, Portland, Seattle, San Diego, Boston, London, Israel and on our home turf in NYC and Dublin. The talks have covered deep learning, design thinking, data streaming and developer experience to name just a...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/07/31/tiefvision-2/" class="snippet__link" title="Visually Similar Recommendations">Visually Similar Recommendations</a></h1><div class="snippet__meta"><span class="meta__day">31</span> <span class="meta__month">JUL</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#personalization">personalization</a> <span class="slug-divider"></span> <span class="meta__author">Chris Curro</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/07/31/tiefvision-2/" class="snippet__link" title="Visually Similar Recommendations"><p class="snippet__excerpt"></p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/agile/2017/07/27/large-scale-retro/" class="snippet__link" title="How Large Is YOUR Retrospective?">How Large Is YOUR Retrospective?</a></h1><div class="snippet__meta"><span class="meta__day">27</span> <span class="meta__month">JUL</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#agile">agile</a> <span class="slug-divider"></span> <span class="meta__author"><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/dana-pylayeva">Dana Pylayeva</a><span class="meta__author-job-title">, Senior Developer</span></span></div><a href="https://saksdirect.github.io/hbc-tech-blog/agile/2017/07/27/large-scale-retro/" class="snippet__link" title="How Large Is YOUR Retrospective?"><p class="snippet__excerpt">Can you recall the size and length of your typical retrospective? If your team operates by The Scrum Guide, your retrospectives likely have less than ten people in one room and last about an hour for a two-weeks Sprint.</p></a></section></article></div></aside></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><ul class="navigation navigation--footer"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/about" class="navigation__link"><span class="navigation__link-highlight">About</span></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/get-gh-repos.js"></script></body></html>