<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>How to convert fully connected layers into equivalent convolutional ones</title><title>How to convert fully connected layers into equivalent convolutional ones | HBC Tech</title><meta property="og:title" content="How to convert fully connected layers into equivalent convolutional ones"><meta name="author" content="Pau Carré Cardona"><meta property="og:locale" content="en_US"><meta name="description" content="The Problem"><meta property="og:description" content="The Problem"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-05-18T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Pau Carré Cardona"><script type="application/ld+json">{"name":null,"description":"The Problem","author":{"@type":"Person","name":"Pau Carré Cardona"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/","publisher":null,"image":null,"headline":"How to convert fully connected layers into equivalent convolutional ones","dateModified":"2016-05-18T00:00:00-05:00","datePublished":"2016-05-18T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body class="container" aria-label="Content"><header id="site-header" class="site-header site-header--scaled"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-stripes-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-stripe hbc-stripe--green" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-green"></use><use class="hbc-stripe hbc-stripe--red" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-red"></use><use class="hbc-stripe hbc-stripe--yellow" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-yellow"></use><use class="hbc-stripe hbc-stripe--blue" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#hbc-blue"></use><use class="hbc-stripes-logo--text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-tech-logo-primary.svg#text"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#deep learning" class="meta__category">deep learning</a> <span class="meta__title">How to convert fully connected layers into equivalent convolutional ones</span></p><ul class="navigation"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul></header><section class="content"><article class="article"><section class="article__no-feature-image"></section><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#deep learning" class="article-meta__category">deep learning</a> <span class="article-meta__date">Published 18 MAY 2016</span></div><h1 class="article__content__title" title="How to convert fully connected layers into equivalent convolutional ones">How to convert fully connected layers into equivalent convolutional ones</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">6 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/&title=How to convert fully connected layers into equivalent convolutional ones" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//deep%20learning/2016/05/18/fully-connected-to-convolutional-conversion/" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><h2 id="the-problem">The Problem</h2><p>Say we want to build system to detect dresses in images using a deep convolutional network. What we have is a database of <strong>64x128</strong> pixels images that either fully contain a dress or another object (a tree, the sky, a building, a car…). With that data we train a deep convolutional network and we end up successfully with a high accuracy rate in the test set.</p><p>The problem comes when trying to detect dresses on arbitrarily large images. As images from cameras are usually far larger than <strong>64x128</strong> pixels, the output of the last convolutional layer will also be larger. Thus, the fully connected layer won’t be able to use it as the dimensions will be incompatible. This happens because a fully connected layer is a matrix multiplication and it’s not possible to multiply a matrix with vectors or matrices of arbitrary sizes.</p><p>Let’s assume we have <strong>1024x512</strong> pixels images taken from a camera. In order to detect dresses in an image, we would need to first forward it throughout the convolutional layers. This will work as convolutional layers can adapt to larger input sizes. Assuming the convolutional and max pool layers reduce the input dimensions by a factor of <strong>32</strong>, we would get an output of <strong>32x16</strong> units in the last convolutional layer. On the other hand, for the training and test images of <strong>64x128</strong> pixels, we would get an output of <strong>2x4</strong> units. That size of <strong>2x4</strong> units is the only one the fully connected layer matrix is compatible with.</p><p>Now the question is, how do we convert our camera <strong>32x16</strong> units into the fully connected <strong>2x4</strong> units ?</p><h2 id="the-wrong-solution">The Wrong Solution</h2><p>One way to do it is by simply generating all possible <strong>2x4</strong> crops from the <strong>32x16</strong> units. That means we would generate <strong>403</strong> samples of <strong>2x4</strong> units ( (32 - 2 + 1) x (16 - 4 + 1) = 403 ). Finally, we would go one by one forwarding those <strong>403</strong> samples throughout the fully connected layers and arrange them spatially.</p><p>The problem with that approach is that the cost of cropping and forwarding images throughout the fully connected layers can be impractical. On top of that, if the network reduction factor is lower or the camera images have a higher resolution, the number of samples will grow in a multiplicative way.</p><h2 id="the-right-solution">The Right Solution</h2><p>Fortunately, there is a way to convert a fully connected layer into a convolutional layer. First off, we will have to define a topology for our fully connected layers and then convert one by one each fully connected layer. Let’s say we have a first fully connected layer with <strong>4</strong> units and a final single binary unit that outputs the probability of the image being a dress. This diagram describes the topology:</p><p align="center"><img src="http://i.imgur.com/yclyo3S.png"></p><h3 id="converting-the-first-fully-connected-layer">Converting the first fully connected layer</h3><p>The idea here is to transform the matrix <strong>A</strong> into a convolutional layer. Doing that it’s pretty straightforward as the rows of the matrix <strong>A</strong> can be interpreted as convolutions applied to the flattened input <strong>V</strong>.</p><p>Let’s first write down the classical deep learning convolution operator:</p><p align="center"><img src="http://i.imgur.com/HMmxG23.png"></p><p>When both the signal and the filter are of the same size, the convolution will generate a vector of size one. Hence, the convolution will be equivalent to the dot product:</p><p align="center"><img src="https://i.imgur.com/o67Atee.png"></p><p>Applying this property to our convolutional conversion task, we will be able to transform a linear operator into a vector of convolutions:</p><p align="center"><img src="http://i.imgur.com/sWGZaAX.png"></p><p>Therefore, we have the following transformed convolutional layer for the first fully connected layer:</p><p align="center"><img src="http://i.imgur.com/gkM8T2p.png"></p><p>More formally, we will have as many feature maps as rows the matrix <strong>A</strong> has. Furthermore, the <strong>i</strong>-th feature map will have as filter the <strong>i</strong>-th row of the matrix <strong>A</strong>.</p><p>Here we are assuming that the input of the fully connected layer is flattened and also that the fully connected layer only receives a single feature map from the last convolutional layer. For multidimensional convolutions with many feature maps, the transformation will depend on the way the framework we use encodes the different layer types (convolutional and fully connected).</p><p>In case of <a href="http://torch.ch/">Torch</a>, it’s pretty easy as one simply has to copy the biases and the weights of the fully connected layer into the convolutional layer. The caveat is that the convolutional layer has to be declared using the following parameters:</p><ul><li><p><strong>Number of input feature maps</strong>: as many as output feature maps the last convolutional layer has.</p></li><li><p><strong>Number of output feature maps</strong>: number of outputs the fully connected layer has.</p></li><li><p><strong>Filter dimensions</strong>: the dimensions of the output of each feature map in the last convolutional layer (we assume the all of the feature maps have the same output dimensions).</p></li></ul><h3 id="converting-the-second-fully-connected-layer">Converting the second fully connected layer</h3><p>After the first transformation we will have in the second fully connected layer an input that has many feature maps of size one.</p><p>The equivalent convolutional layer will be the following:</p><ul><li><p><strong>Number of input feature maps</strong>: as many input feature maps as output feature maps the last transformed convolutional layer has. It will also be equivalent to the input units the original second fully connected layer has.</p></li><li><p><strong>Number of output feature maps</strong>: as many output feature maps as outputs the second fully connected layer has. In our case we have a single output and therefore the layer will only have a single output feature map. In case we would have more outputs or an additional fully connected layer, we would need to add more feature maps.</p></li><li><p><strong>Filter values</strong>: the filter architecture is pretty simple as all the input feature maps have units of size one. This implies that the filters will be of size one. The value of the filter in the feature map that connects the <strong>n</strong>-th input unit with the <strong>m</strong>-th output unit will be equal to the element in the <strong>n</strong>-th column and the <strong>m</strong>-th row of the matrix <strong>B</strong>. For our specific case there is one single output, thus <strong>m</strong> is equal to <strong>1</strong>. This makes the transformation even easier. Nevertheless, we should keep in mind that we could potentially have multiple outputs.</p></li></ul><p>For our example, the second fully connected layer will be converted into the following convolutional layer:</p><p align="center"><img src="http://i.imgur.com/IdIV2rs.png"></p><h2 id="always-be-convolutional">Always be convolutional</h2><p>In this post we’ve discussed how to transform fully connected layers into an equivalent convolutional layer. Once the network no longer has fully connected layers, we will be able to get rid of all the problems they cause when dealing with inputs of arbitrary sizes.</p><p>Nevertheless, when designing a new neural network from scratch it’s always a good idea to design it substituting all fully connected layers with convolutional layers. This way, there is not only no need for any conversion but we will also get far more flexibility in our network architecture.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">deep learning</span><span>,</span> <span class="article-tags__tag">convolutional neural networks</span><span>,</span> <span class="article-tags__tag">image detection</span><span>,</span> <span class="article-tags__tag">torch</span><span>,</span> <span class="article-tags__tag">Pau Carré Cardona</span></div><section class="author"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Pau Carré Cardona</span></section></footer></section></article><aside class="recirc"><h2 class="header__title">More Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">Explore Categories</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/machine%20learning/2016/12/22/deep-learning-at-gilt/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/machine%20learning/2016/12/22/deep-learning-at-gilt/" class="snippet__link" title="Deep Learning at GILT">Deep Learning at GILT</a></h1><div class="snippet__meta"><span class="meta__day">22</span> <span class="meta__month">DEC</span> <span class="meta__year">2016</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#machine learning">machine learning</a> <span class="slug-divider"></span> <span class="meta__author">Pau Carré Cardona</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/machine%20learning/2016/12/22/deep-learning-at-gilt/" class="snippet__link" title="Deep Learning at GILT"><p class="snippet__excerpt">Cognitive Fashion Industry Challenges</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree">Dublin Scala Spree</a></h1><div class="snippet__meta"><span class="meta__day">11</span> <span class="meta__month">SEP</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#open source">open source</a> <span class="slug-divider"></span> <span class="meta__author">Gregor Heine</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree"><p class="snippet__excerpt">Dublin Scala Spree This Friday the Gilt/HBC Digital Dublin office will be hosting the first ever Dublin Scala Spree, a day-long Scala Open Source Hackathon. The event is organized by the Dublin Scala Usergroup in cooperation with Dublin Functional Kubs and the Scala Center at EPFL in Lausanne, Switzerland. Date &amp; Time: Friday, 15th September, 10am - 4pm Location: Gilt/HBC Digital Office, Shelbourne Rd., Dublin 4, Ireland Sign-Up: Please register...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017">HBC Tech Talks: February 2017 through July 2017</a></h1><div class="snippet__meta"><span class="meta__day">10</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/conferences">conferences</a> <span class="slug-divider"></span> <span class="meta__author"><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/hbc-tech">HBC Tech</a></span></div><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017"><p class="snippet__excerpt">We’ve had a busy 2017 at HBC. The great work of our teams has created opportunities to share what we’ve learned with audiences around the world. This year our folks have been on stage in Austin, Sydney, Portland, Seattle, San Diego, Boston, London, Israel and on our home turf in NYC and Dublin. The talks have covered deep learning, design thinking, data streaming and developer experience to name just a...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?">Sundial or AWS Batch, Why not both?</a></h1><div class="snippet__meta"><span class="meta__day">4</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#data">data</a> <span class="slug-divider"></span> <span class="meta__author">Kevin O'Riordan</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?"><p class="snippet__excerpt">About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service.</p></a></section></article></div></aside></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><ul class="navigation navigation--footer"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script></body></html>