<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Increasing Build IQ with Travis CI</title><title>Increasing Build IQ with Travis CI | HBC Tech</title><meta property="og:title" content="Increasing Build IQ with Travis CI"><meta name="author" content="Andrew Powell"><meta property="og:locale" content="en_US"><meta name="description" content="Continuous Integration is a must these days. And for social, open source projects it’s crucial. Our tool of choice for automated testing is Travis CI. Like most tools, Travis does what it does well. Unfortunately it’s not very “smart”. Heaven help you if you have a large or modular project with a multitude of tests - you’ll be waiting an eternity between builds."><meta property="og:description" content="Continuous Integration is a must these days. And for social, open source projects it’s crucial. Our tool of choice for automated testing is Travis CI. Like most tools, Travis does what it does well. Unfortunately it’s not very “smart”. Heaven help you if you have a large or modular project with a multitude of tests - you’ll be waiting an eternity between builds."><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-11-16T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Andrew Powell"><script type="application/ld+json">{"name":null,"description":"Continuous Integration is a must these days. And for social, open source projects it’s crucial. Our tool of choice for automated testing is Travis CI. Like most tools, Travis does what it does well. Unfortunately it’s not very “smart”. Heaven help you if you have a large or modular project with a multitude of tests - you’ll be waiting an eternity between builds.","author":{"@type":"Person","name":"Andrew Powell"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html","publisher":null,"image":null,"headline":"Increasing Build IQ with Travis CI","dateModified":"2016-11-16T00:00:00-05:00","datePublished":"2016-11-16T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body aria-label="Content"><header id="site-header" class="site-header"><div class="site-header__inner"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 64 52"><use class="hbc-tech-logo__text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/front-end" class="meta__category">front end</a> <span class="slug-divider"></span> <span class="meta__title">Increasing Build IQ with Travis CI</span></p><nav id="menu" class="navigation"><svg class="navigation__menu-icon" xmlns="http://www.w3.org/2000/svg"><path class="bar bar__top" d="M0,3 L30,3"></path><path class="bar bar__cross-1" d="M0,14 L30,14"></path><path class="bar bar__cross-2" d="M0,14 L30,14"></path><path class="bar bar__bottom" d="M0,25 L30,25"></path></svg><menu class="menu"><ul class="link-list"><li class="link-list__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/" class="link-list__link"><span class="link-list__link-highlight">Insights</span></a></li><li class="link-list__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="link-list__link"><span class="link-list__link-highlight">Code</span></a></li><li class="link-list__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/about" class="link-list__link"><span class="link-list__link-highlight">About</span></a></li><li class="link-list__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/work-here" class="link-list__link"><span class="link-list__link-highlight">Work Here</span></a></li></ul></menu></nav><search id="header-search" class="header-search"><form class="header-search__form"><input type="text" class="header-search__input" id="header-search-input" placeholder="Search" name="query"></form><svg id="header-search__toggle" class="header-search__svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 64 52"><use class="header-search__icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#search"></use></svg><section class="header-search__results" id="header-search__results"></section></search></div></header><section class="content"><article class="article"><header class="article__header article__header--reveal"><h1 class="header-title" title="Increasing Build IQ with Travis CI">Increasing Build IQ with Travis CI</h1><span id="no-image-placeholder" class="no-image-placeholder"></span><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/front-end" class="article-meta__category">front end</a> <span class="slug-divider"></span> <span class="article-meta__author">Andrew Powell</span> <span class="slug-divider"></span> <span class="article-meta__date">NOV 16, 2016</span></div></header><section class="article__content article__content--reveal"><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">4 min</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//2016-11-16-increasing-build-iq-travis-ci.html" class="share-buttons__link" title="Share on Twitter" target="_blank"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/2016-11-16-increasing-build-iq-travis-ci.html&title=Increasing Build IQ with Travis CI" class="share-buttons__link" title="Share on Linkedin" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//2016-11-16-increasing-build-iq-travis-ci.html" class="share-buttons__link" title="Share on Facebook" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//2016-11-16-increasing-build-iq-travis-ci.html" class="share-buttons__link" title="Share on Reddit" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><p>Continuous Integration is a must these days. And for social, open source projects it’s crucial. Our tool of choice for automated testing is <a href="https://travis-ci.org/">Travis CI</a>. Like most tools, Travis does what it does well. Unfortunately it’s not very “smart”. Heaven help you if you have a large or modular project with a multitude of tests - you’ll be waiting an eternity between builds.</p><p>And that’s exactly what we ran into. We have a repository that contains <em>30 NPM modules</em>, each with their own specs (tests). These modules are part of an aging assets pipeline that I <a href="http://tech.gilt.com/node/2016/11/09/linting-npm-version-conflicts">briefly mentioned</a> last week. As such each module is subject to a litany of tasks each time a change is made. Travis CI is hooked into the repo and for each Pull Request would run specs for every module, assuring that there are no errors in the code changes contained in the PR. When you’re only working on one or two modules the run-time for the tasks is relatively low; typically 1 - 2 minutes. That of course depends on things such as <code class="highlighter-rouge">npm install</code> time, as each module requires an install for testing. <em>Multiply that by 30</em> and you start to see where the problem arises.</p><h2 id="waiting-sucks">Waiting Sucks</h2><p>Without targeted build testing we’re left waiting or task-shifting until the build completes successfully. Our need was clear: figure out what files were affected, map and filter the results, and run only the specs for the modules changed in any particular Pull Request or push. That’s where <a href="https://www.npmjs.com/package/travis-target">travis-target</a> comes into play.</p><p>Here’s a snippet of our repo structure, for reference:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ui-tracking
|--src
   |--common
      |--event_registry
      |--tracking_metadata
   |--tracking
      |--cart
      |--etc..
</code></pre></div></div><h2 id="target-acquired">Target Acquired</h2><p>In order to target modules, we need to know what their normalized names are; the names that we publish them to NPM under. Because of some legacy stuff baked into our pipeline, we store modules at <code class="highlighter-rouge">group/name</code> but publish them as <code class="highlighter-rouge">group.name</code>. So let’s fire up <code class="highlighter-rouge">travis-target</code> (bear in mind we’re using ES6 syntax that Node v7 supports).</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'travis-target'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/^src</span><span class="se">\/</span><span class="sr">/</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">targets</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">target</span><span class="p">();</span>
</code></pre></div></div><p>Let’s pretend that the <code class="highlighter-rouge">common.event_registry</code> and <code class="highlighter-rouge">tracking.cart</code> modules were both modified in one Pull Request (a common pattern for us) - our results would could look like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="s1">'README.md'</span><span class="p">,</span>
  <span class="s1">'src/common/event_registry/js/event_registry.js'</span><span class="p">,</span>
  <span class="s1">'src/common/event_registry/js/registry.js'</span><span class="p">,</span>
  <span class="s1">'src/common/event_registry/package.json'</span><span class="p">,</span>
  <span class="s1">'src/tracking/cart/js/cart.js'</span><span class="p">,</span>
  <span class="s1">'src/tracking/cart/package.json'</span>
<span class="p">]</span>
</code></pre></div></div><p>But that’s just silly, so let’s give <code class="highlighter-rouge">travis-target</code> some options to work with:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'travis-target'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/^src</span><span class="se">\/</span><span class="sr">/</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">targets</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">target</span><span class="p">({</span>
  <span class="na">pattern</span><span class="p">:</span> <span class="nx">pattern</span><span class="p">,</span>
  <span class="na">map</span><span class="p">:</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">parts</span><span class="p">;</span>

    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
    <span class="nx">parts</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div><p>By passing <code class="highlighter-rouge">pattern</code> in options, we’re telling <code class="highlighter-rouge">travis-target</code> to filter on (or return only those results which match) the regular expression pattern. That gives us an initial result set of directories starting with <code class="highlighter-rouge">src/</code>.</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="s1">'src/common/event_registry/js'</span><span class="p">,</span>
  <span class="s1">'src/tracking/cart/js'</span>
<span class="p">]</span>
</code></pre></div></div><p>You’ll notice that the initial example of results contained some duplicate directories; travis-target cleans that up for you.</p><p>Next, we specify the <code class="highlighter-rouge">map</code> function on options. That’ll let us transform the each element in the <code class="highlighter-rouge">Array</code> of results so that it’s ready to use. Our results would now look like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="s1">'common.event_registry'</span><span class="p">,</span>
  <span class="s1">'tracking.cart'</span>
<span class="p">]</span>
</code></pre></div></div><h2 id="great-justice">Great Justice</h2><p>Using this last result set, we now know which modules were affected in the PR, and we know which modules to run specs for. Our next steps are firing off a sequence of shell commands using <a href="https://www.npmjs.com/package/@exponent/spawn-async">@exponent/spawn-async</a>, which plays nicely with <code class="highlighter-rouge">async/await</code> patterns now supported in Node v7.1 with the <code class="highlighter-rouge">--harmony-async-await</code> flag.</p><p>Since we implemented this pattern, build times for our PRs are in the 1-2 minute range; a vast improvement and one sure to bring developer happiness in some small degree.</p><h3 id="cheers">Cheers!</h3><p><em>Originally published at <a href="http://shellscape.org/2016/11/16/increasing-build-iq-travis-ci">shellscape.org</a> on November 16, 2016.</em></p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">continuous integration</span><span>,</span> <span class="article-tags__tag">node.js</span><span>,</span> <span class="article-tags__tag">open source</span><span>,</span> <span class="article-tags__tag">travis ci</span></div><section class="author-bio"><svg class="author-bio__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author-bio__name">Andrew Powell</span></section></footer></section><aside class="recirc"><h2 class="header__title">Recent Insights</h2><span class="slug-divider"></span> <a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">See All</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-09-linting-npm-version-conflicts.html" class="snippet__title__link" title="Linting NPM Version Conflicts">Linting NPM Version Conflicts</a></h1><div class="snippet__meta"><a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front-end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span> <span class="slug-divider"></span> <span class="meta__date">NOV 9, 2016</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-09-linting-npm-version-conflicts.html" class="snippet__excerpt__link" title="Linting NPM Version Conflicts"><p class="snippet__excerpt">Say you had the need for shared front-end assets (scripts, stylesheets, images, etc.) and a need for an entire org to access them, independently, for reliable builds of many different apps which used those assets. NPM might be a good choice - With NPM’s move to a flat-ish install tree, it’s still a relevant choice. But what about package version conflicts?</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-04-running-with-koa-vuejs.html" class="snippet__title__link" title="Running with Scissors: Koa2 and Vue.js">Running with Scissors: Koa2 and Vue.js</a></h1><div class="snippet__meta"><a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front-end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span> <span class="slug-divider"></span> <span class="meta__date">NOV 4, 2016</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-04-running-with-koa-vuejs.html" class="snippet__excerpt__link" title="Running with Scissors: Koa2 and Vue.js"><p class="snippet__excerpt">We love Koa at Gilt. (Hell, I love Koa.) Embarking on a new project, I wanted to try something that wasn’t React or Angular. After poking at the alternatives I landed on Vue.js. I picked up the sharpest pair of scissors I could find and started running.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-02-15-gulp-scan-find-strings.html" class="snippet__title__link" title="gulp-scan &bull; Find Yourself Some Strings">gulp-scan &bull; Find Yourself Some Strings</a></h1><div class="snippet__meta"><a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front-end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span> <span class="slug-divider"></span> <span class="meta__date">FEB 15, 2016</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-02-15-gulp-scan-find-strings.html" class="snippet__excerpt__link" title="gulp-scan &bull; Find Yourself Some Strings"><p class="snippet__excerpt">We recently ran across the need to simply scan a file for a particular term during one of our build processes. Surpringly enough, we didn’t find a Gulp plugin that performed only that one simple task. And so gulp-scan was born and now resides on npmjs.org.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html" class="snippet__title__link" title="Private NPM Modules&#58; A Song of Fire and Ice">Private NPM Modules&#58; A Song of Fire and Ice</a></h1><div class="snippet__meta"><a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front-end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span> <span class="slug-divider"></span> <span class="meta__date">AUG 3, 2015</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html" class="snippet__excerpt__link" title="Private NPM Modules&#58; A Song of Fire and Ice"><p class="snippet__excerpt">Grab a coffee or pop and a snack, this is a read.</p></a></section></article></div></aside></article></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/jekyll-search-js/fetch.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/jekyll-search-js/search.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script></body></html>