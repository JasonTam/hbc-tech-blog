<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Private NPM Modules&amp;#58; A Song of Fire and Ice</title><title>Private NPM Modules: A Song of Fire and Ice | HBC Tech</title><meta property="og:title" content="Private NPM Modules: A Song of Fire and Ice"><meta name="author" content="Andrew Powell"><meta property="og:locale" content="en_US"><meta name="description" content="Grab a coffee or pop and a snack, this is a read."><meta property="og:description" content="Grab a coffee or pop and a snack, this is a read."><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2015-08-03T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Andrew Powell"><script type="application/ld+json">{"name":null,"description":"Grab a coffee or pop and a snack, this is a read.","author":{"@type":"Person","name":"Andrew Powell"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html","publisher":null,"image":null,"headline":"Private NPM Modules: A Song of Fire and Ice","dateModified":"2015-08-03T00:00:00-05:00","datePublished":"2015-08-03T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2015-08-03-gilt-private-npm-modules-npmjsorg.html"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body aria-label="Content"><header id="site-header" class="site-header--sub-page"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 64 52"><use class="hbc-tech-logo__text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/front end" class="meta__category">front end</a> <span class="meta__title">Private NPM Modules&#58; A Song of Fire and Ice</span></p><nav class="navigation"><a href="https://saksdirect.github.io/hbc-tech-blog/" class="navigation__link"><svg class="navigation__link__svg-icon" xmlns="http://www.w3.org/2000/svg"><path class="bar bar__top" d="M0,3 L30,3"></path><path class="bar bar__middle" d="M0,14 L30,14"></path><path class="bar bar__bottom" d="M0,25 L30,25"></path></svg></a></nav></header><section class="content"><article class="page article"><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/front end" class="article-meta__category">front end</a> <span class="article-meta__date">Published 3 AUG 2015</span></div><h1 class="article__content__title" title="Private NPM Modules&#58; A Song of Fire and Ice">Private NPM Modules&#58; A Song of Fire and Ice</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">7 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//2015-08-03-gilt-private-npm-modules-npmjsorg.html" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/2015-08-03-gilt-private-npm-modules-npmjsorg.html&title=Private NPM Modules&#58; A Song of Fire and Ice" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//2015-08-03-gilt-private-npm-modules-npmjsorg.html" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//2015-08-03-gilt-private-npm-modules-npmjsorg.html" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><p>Grab a coffee or pop and a snack, this is a read.</p><p>Several years ago, Gilt Tech decided to adopt a new strategy for developing the overall Gilt platform. It was determined that many small applications should comprise Gilt.com, rather than one (or few) large monolithic applications. We called this strategy ‘Lots of Small Applications,’ or ‘LOSA.’ Key to LOSA were decentralized, distributed front-end assets. Enter <a href="https://www.npmjs.com/about">NPM</a>.</p><p>Our requirements for how this was to work was varied, and we authored build tools to facilitate them. Our build tools solved many problems that at the time, didn’t have solutions. We also knew we couldn’t rely on external services to host our modules, because we need to know that the registry these little guys were stored in needed to <em>always</em> be available. NPM was still new, and npmjs.org was still a baby back then. Third-party SaaS providers weren’t a thing for this yet. And so we spun up our own NPM registry in-house. This worked for years, and worked well - until one day it became obvious that we were hopelessly out of date.</p><p>June 2014: A framework for developing NodeJS applications at Gilt took shape, and the need to start installing public modules from npmjs.org became real. The architects of the in-house registry had long-since parted ways with Gilt, and we scrambled to try and update an aged system. We attempted to implement a proxy from our private registry to the public. Things worked, but not well, and it was decided that we’d look to a third-party for our registry needs. We eventually settled on a well-known company in the NodeJS space. We were able to migrate our internal registry to their service, and everything worked very, very well.</p><p>In February of this year we were informed that a very large entity, we’ll call them “MovableUncle,” had purchased the registry-hosting company and they would cease their registry business. We knew we’d have to move off of the platform and began carefully and cautiously considering alternatives. We were told that we’d have until December 2015 - and then someone rolled in the dumpster and lit that baby afire. The registry company experienced massive attrition, including all of their support staff, resulting in a near-complete inability to get support. Our data was locked there, and despite exhausting many channels of communication, we were unable to procure a backup archive of our data. Some amount of panic set in when their website was updated to show August 2015 as the cutoff date.</p><p>Without knowing for sure just when the service would go down, <a href="https://www.youtube.com/watch?v=NU0PijNCEwo">we knew it was time to act</a>, and quickly. We identified the three most viable options for moving forward: Hosting in-house again, going with another private registry SaaS provider that Gilt was already using for a different service, or going with the newly announced <a href="https://www.npmjs.com/private-modules">Private Modules offering</a> on npmjs.org.</p><p>After much discussion and weighing the options against one-another, we decided to bite the bullet and go with npmjs.org. That bullet we had to bite meant a lot of changes internally. Their <a href="https://docs.npmjs.com/getting-started/scoped-packages">scoping mechanism</a> while elegant for installing modules and organization, was an enormous pain point for Gilt - it meant we had to update the names and dependencies for 220 modules. We’d also be losing our history of published modules covering nearly four years. Representatives for npmjs.org explicitly told us there was no way to import a registry, even if we could get a backup out of the dumpster fire. That also meant that we’d have to <em>republish 220 modules</em>.</p><p><strong><a href="https://www.youtube.com/watch?v=w6Qhc-8cxMU">‘Aint Got Time To Bleed</a></strong>, as August was fast-approaching. This process required either a metric poop-ton of man-hours, or some quasi-clever scripts. We put together two NodeJS scripts;</p><ol><li><code class="highlighter-rouge">npm-registry-backup</code> would pull down a manual backup of our registry. That would mean iterating over all of our modules in the repo, fetching the <code class="highlighter-rouge">npm info</code> for each, and downloading the tarball for each revision.</li><li><code class="highlighter-rouge">npm-scope</code> would iterate through a target directory looking for package.json files, update the name by adding our npmjs.org scope, adding the scope to any private modules in the dependencies property, and then finally publishing the module to npmjs.org. This script also allowed us to automagically update our apps that had private module dependencies.</li></ol><p>We’ll make those scripts publicly available in the coming week(s) once we’re out of the forest. From start to finish the process took about 9 man-hours (3 hours / 3 fellas) for backup and update of 220 modules, distributed through 14 different git repositories. Getting everything just right across the org was another matter altogether. Switching module paradigms isn’t a trivial thing when the org has relied on one model for a few years.</p><p><a href="https://www.youtube.com/watch?v=pele5vptVgc">Knowing Is Half The Battle</a> and to say we learned a lot from this ordeal would be an understatement the size of Texas.</p><h2 id="build-tools">Build Tools</h2><p>One of my favorite Gilt-isms is <em>“It solved the problem at the time.”</em> Our primary build tool (named <code class="highlighter-rouge">ui-build</code>) for front-end assets was written a few years ago when we still thought Rake was all the hotness. It’s a brilliant piece of code and study in Ruby polymorphism - unfortunately it’s infested with massively complex regular expressions, hardcoded assumptions about filesystem locations, and chock-full of <em>black magic</em>. <em>“Black magic”</em> is the term we use at Gilt for all of the things in <code class="highlighter-rouge">ui-build</code> that were written by people no longer with the company, for which we don’t know it’s doing. Once we updated <code class="highlighter-rouge">ui-build</code> to handle scoped modules, we learned that we had to <em>republish</em> around 80 modules, due to black magic. We require publishing of modules to go through the build tool so that things like linting and verification of certain data and standards are performed prior to actually publishing to npm. We learned that in that process, things like automatic compilation of LESS and manipulation of vendor code, are done <em>SILENTLY</em>.</p><p>While our next-generation, gulp-based build tool is being polished and rolled-out, we’ve used this lesson to ensure that we don’t have gaps in knowledge and documentation like we experienced with <code class="highlighter-rouge">ui-build</code>. We’re also using this opportunity to explore how we can use the standard processes of npm to perform <code class="highlighter-rouge">pre-publish</code> or <code class="highlighter-rouge">post-install</code> steps and remove the need for black magic.</p><h2 id="maintenance-maintenance-maintenance">Maintenance, Maintenance, Maintenance</h2><p>Some of our apps are so out-of-date they might as well be wearing bell-bottoms and driving <a href="https://jimburgan71.files.wordpress.com/2008/04/76gremlin.jpg">Gremlins</a>. So so so many apps had dependencies on module versions that were a year+ old. Remember - we lost that revision history in the registry when we moved to npmjs.org. Things blew up in epic fashion when attempting builds of many of our less-frequently-maintained apps. Some of the dependencies were so stubborn that we had to republish the tarballs for old versions that we had pulled down from <code class="highlighter-rouge">npm-registry-backup</code>.</p><p>We need to be better at updating our apps. It doesn’t always make cost-benefit sense to management, but it helps eliminate technical debt that we paid for in man-hours during this process. On top of the the original 9 man-hours, we had to spend roughly an additional 32 man-hours (8 hours / 4 fellas) with subsequent clean-up. There is progress on this front, however; Gilt Tech recently embarked on an ownership campaign internally called the ‘Genome Project’ which should help address this concern.</p><h2 id="conclusion-or-potty-break">Conclusion, or Potty Break</h2><p>Overall the move was a success. We’re still chasing the occasional edge case and build problem, but the major hurdles have been overcome. The improvement in speed and reliability of NPM over the SaaS registry host has been marked. We’re able to use the latest features of the NPM registry and have regained the ability to unpublish; something we lost with the SaaS host. The technical improvements coupled with the knowledge we’ve gained have made the endeavor worthwhile. And unless “MovableUncle” inexplicably acquires npmsj.org, we’ve set the company up for stability in this area for some time to come.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">npm</span><span>,</span> <span class="article-tags__tag">private modules</span><span>,</span> <span class="article-tags__tag">tools</span><span>,</span> <span class="article-tags__tag">rake</span><span>,</span> <span class="article-tags__tag">gulp</span></div><section class="author-bio"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Andrew Powell</span></section></footer></section><aside class="recirc"><h2 class="header__title">Recent Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">See All</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html" class="snippet__title__link" title="Increasing Build IQ with Travis CI">Increasing Build IQ with Travis CI</a></h1><div class="snippet__meta"><span class="meta__day">16</span> <span class="meta__month">NOV</span> <span class="meta__year">2016</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-16-increasing-build-iq-travis-ci.html" class="snippet__excerpt__link" title="Increasing Build IQ with Travis CI"><p class="snippet__excerpt">Continuous Integration is a must these days. And for social, open source projects it’s crucial. Our tool of choice for automated testing is Travis CI. Like most tools, Travis does what it does well. Unfortunately it’s not very “smart”. Heaven help you if you have a large or modular project with a multitude of tests - you’ll be waiting an eternity between builds.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-09-linting-npm-version-conflicts.html" class="snippet__title__link" title="Linting NPM Version Conflicts">Linting NPM Version Conflicts</a></h1><div class="snippet__meta"><span class="meta__day">9</span> <span class="meta__month">NOV</span> <span class="meta__year">2016</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-09-linting-npm-version-conflicts.html" class="snippet__excerpt__link" title="Linting NPM Version Conflicts"><p class="snippet__excerpt">Say you had the need for shared front-end assets (scripts, stylesheets, images, etc.) and a need for an entire org to access them, independently, for reliable builds of many different apps which used those assets. NPM might be a good choice - With NPM’s move to a flat-ish install tree, it’s still a relevant choice. But what about package version conflicts?</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-04-running-with-koa-vuejs.html" class="snippet__title__link" title="Running with Scissors: Koa2 and Vue.js">Running with Scissors: Koa2 and Vue.js</a></h1><div class="snippet__meta"><span class="meta__day">4</span> <span class="meta__month">NOV</span> <span class="meta__year">2016</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-11-04-running-with-koa-vuejs.html" class="snippet__excerpt__link" title="Running with Scissors: Koa2 and Vue.js"><p class="snippet__excerpt">We love Koa at Gilt. (Hell, I love Koa.) Embarking on a new project, I wanted to try something that wasn’t React or Angular. After poking at the alternatives I landed on Vue.js. I picked up the sharpest pair of scissors I could find and started running.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2016-02-15-gulp-scan-find-strings.html" class="snippet__title__link" title="gulp-scan &bull; Find Yourself Some Strings">gulp-scan &bull; Find Yourself Some Strings</a></h1><div class="snippet__meta"><span class="meta__day">15</span> <span class="meta__month">FEB</span> <span class="meta__year">2016</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/front end">front end</a> <span class="slug-divider"></span> <span class="meta__author">Andrew Powell</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2016-02-15-gulp-scan-find-strings.html" class="snippet__excerpt__link" title="gulp-scan &bull; Find Yourself Some Strings"><p class="snippet__excerpt">We recently ran across the need to simply scan a file for a particular term during one of our build processes. Surpringly enough, we didn’t find a Gulp plugin that performed only that one simple task. And so gulp-scan was born and now resides on npmjs.org.</p></a></section></article></div></aside></article></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/get-gh-repos.js"></script></body></html>