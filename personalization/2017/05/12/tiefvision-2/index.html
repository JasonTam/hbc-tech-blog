<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Visually Similar Recommendations</title><title>Visually Similar Recommendations | HBC Tech</title><meta property="og:title" content="Visually Similar Recommendations"><meta name="author" content="Chris Curro"><meta property="og:locale" content="en_US"><meta name="description" content="We power the website and mobile experiences for Saks, Saks Off Fifth, Gilt, Lord &amp; Taylor and The Bay."><meta property="og:description" content="We power the website and mobile experiences for Saks, Saks Off Fifth, Gilt, Lord &amp; Taylor and The Bay."><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/05/12/tiefvision-2/"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/05/12/tiefvision-2/"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-05-12T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Chris Curro"><script type="application/ld+json">{"name":null,"description":"We power the website and mobile experiences for Saks, Saks Off Fifth, Gilt, Lord &amp; Taylor and The Bay.","author":{"@type":"Person","name":"Chris Curro"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/personalization/2017/05/12/tiefvision-2/","publisher":null,"image":null,"headline":"Visually Similar Recommendations","dateModified":"2017-05-12T00:00:00-05:00","datePublished":"2017-05-12T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/personalization/2017/05/12/tiefvision-2/"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/personalization/2017/05/12/tiefvision-2/"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body class="container" aria-label="Content"><header id="site-header" class="site-header"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#personalization" class="meta__category">personalization</a> <span class="meta__title">Visually Similar Recommendations</span></p><ul class="navigation"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul></header><section class="content"><article class="article"><section class="article__no-feature-image"></section><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/categories/#personalization" class="article-meta__category">personalization</a> <span class="article-meta__date">Published 12 MAY 2017</span></div><h1 class="article__content__title" title="Visually Similar Recommendations">Visually Similar Recommendations</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">7 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//personalization/2017/05/12/tiefvision-2/" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/personalization/2017/05/12/tiefvision-2/&title=Visually Similar Recommendations" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//personalization/2017/05/12/tiefvision-2/" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//personalization/2017/05/12/tiefvision-2/" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><p>Previously we’ve written about about <a href="http://tech.gilt.com/machine/learning,/deep/learning/2016/12/22/deep-learning-at-gilt">Tiefvision</a>, a technical demo showcasing the ability to automatically find similar dresses to a particular one of interest. For example:</p><p><img style="display: block; margin: auto; width: 80%;" src="/assets/images/tiefvision-2/example.png"></p><p>Since then, we’ve worked on taking the ideas at play in Tiefvision, and making them usable in a production scalable way, that allows us to roll out to new product categories besides dresses quickly and efficiently. Today, we’re excited to announce that we’ve rolled out visually similar recommendations for all dresses on Gilt.</p><p>Let’s start with a brief overview. Consider the general task at hand. We have a landing page for every product on our online stores. For the Gilt store, we refer to this as the product detail page (PDP). On the PDP we would like to offer the user a variety of alternatives to the product they are looking at, so that they can best make a purchasing decision. There exist a variety of approaches to selecting other products to display as alternatives; a particularly popular approach is called collaborative filtering which leverages purchase history across users to make recommendations. However this approach is what we call content-agnostic – it has no knowledge of what a particular garment looks like. Instead, we’d like to look at the photographs of garments and recommend similar looking garments within the same category.</p><p>Narrowing our focus a little bit, our task is to take a photograph of a garment and find similar looking photographs. First, we need to come up with some similarity measure for photographs, then we will need to be able to quickly query for the most similar photographs from our large catalog.</p><p>This is something we need to do numerically. Recall that we can represent a photograph as some tensor<script type="math/tex">P \in [0,1]^{H \times W \times 3}</script>(in other words a three dimensional array with entries in between 0 and 1). Given that we have a numerical representation for an photograph, you might think we could so something simple to the measure the similarity between two photographs. Consider:</p><script type="math/tex; mode=display">\text{sim} (P, P^\prime) = \sqrt{\sum\limits_{h=0}^{H-1}\sum\limits_{w=0}^{W-1}\sum\limits_{c=0}^{2} \left(P_{h,w,c} - P^\prime_{h,w,c}\right)^2}</script><p>which we’d refer to as the Frobenius norm of the difference between the two photographs. The problem with this, although it is simple, is that we’re not measuring the difference between semantically meaningful features. Consider these three dresses: a red floral print, pink stripes, and a blue floral print.</p><p><img style="display: block; margin: auto; width: 60%;" src="/assets/images/tiefvision-2/pixel-space-example.png"></p><p>With this “pixel-space” approach the red floral print and the pink stripes are more likely to be recognized as similar than the red floral print and the blue floral print, because they have pixels of similar colors at similar locations. The “pixel-space” approach ignores locality and global reasoning, and has no insight into semantic concepts.</p><p>What we’d like to do is find some function<script type="math/tex">\phi(\cdot)</script>that extracts semantically meaningful features. We can then compute our similarity metric in the feature-space rather than the pixel-space. Where do we get this<script type="math/tex">\phi(\cdot)</script>? In our case, we leverage deep neural networks (deep learning) for this function. Neural networks are hierarchical functions composed of typically sequential connections of simple building blocks. This structure allows us take a neural network trained for a specific task, like arbitrary object recognition and pull from some intermediate point in the network. For example say we take a network, trained to recognize objects in the ImageNet dataset, composed of building blocks<script type="math/tex">f_1, f_2, \dots, f_M</script>:</p><script type="math/tex; mode=display">f\left(P\right) = f_M(f_{M-1}(\cdots f_2(f_1(P))\cdots)</script><p>We might take the output of<script type="math/tex">f_3</script>and call those our features:</p><script type="math/tex; mode=display">\phi(P) = f_3(f_2(f_1(P)))</script><p>In the case of convolutional networks like the VGG, Inception, or Resnet families our output features would lie in some vector space<script type="math/tex">\mathbb{R}^{H^\prime \times W^\prime \times C}</script>. The first two dimensions correspond to the original spatial dimensions (at some reduced resolution) while the third dimension corresponds to some set of<script type="math/tex">C</script>feature types. So in other words, if one of our<script type="math/tex">C</script>feature types detects a human face, we might see a high numerical value in spatial position near where a person’s face is in the photograph. In our use cases, we’ve determined that this spatial information isn’t nearly as important as the feature types that we detect, so at this point we aggregate over the spatial dimensions to get a vector in<script type="math/tex">\mathbb{R}^C</script>. A simple way to do this aggregation is with a simple arithmetic mean but other methods work as well.</p><p>From there we could build up some matrix<script type="math/tex">\Phi \in \mathbb{R}^{N \times C}</script>where<script type="math/tex">N</script>is the number of items in a category of interest. We could then construct an<script type="math/tex">N \times N</script>similarity matrix<script type="math/tex">S</script></p><script type="math/tex; mode=display">S_{ij} = \sqrt{\sum\limits_{k=0}^{C-1} \left(\Phi_{ik} - \Phi_{jk}\right)^2}</script><p>Then to find the most similar items to a query<script type="math/tex">i</script>, we look at the locations of the highest values in row<script type="math/tex">i</script>of the matrix.</p><p>This approach is infeasible as<script type="math/tex">N</script>becomes large, as it has computational complexity<script type="math/tex">O(N^2C)</script>and space complexity<script type="math/tex">O(N^2)</script>. To alleviate this issue, we can leverage a variety of approximate nearest neighbor methods. We empirically find that approximate neighbors are sufficient. Also when we consider that our feature space represents some arbitrary embedding with no guarantees of any particular notion of optimality, it becomes clear there’s no grounded reason to warrant exact nearest neighbor searches.</p><h2 id="how-do-we-do-it">How do we do it?</h2><p>We leverage several open source technologies, as well as established results from published research to serve visually similar garments. As far as open source technology is concerned, we use <a href="https://www.tensorflow.org/">Tensorflow</a>, and (our very own) <a href="https://github.com/gilt/sundial">Sundial</a>. Below you can see a block diagram of our implementation:</p><p><img style="display: block; margin: auto; width: 60%;" src="/assets/images/tiefvision-2/block_diagram.png"></p><p>Let’s walk through this process. First, we have a Sundial job that accomplishes two tasks. We check for new products, and then we compute embeddings using Tensorflow and a pretrained network of a particular type for particular categories of products. We persist the embeddings on AWS S3. Second, we have another Sundial job, again with two tasks. This job filters the set of products to ones of some particular interest and generates a nearest neighbors index for fast nearest neighbor look-ups. The job completes, persisting the index on AWS S3. Finally, we wrap a cluster of servers in a load balancer. Our product recommendation service can query these nodes to get visually similar recommendations as desired.</p><p>Now, we can take a bit of a deeper dive into the thought process behind some of the decisions we make as we roll out to new categories. First, and perhaps the most important, is what network type and where to tap it off so that we can compute embeddings. If we recall that neural networks produce hierarchical representations, we can deduce (and notice empirically) that deeper tap-points (more steps removed from the input) produce embeddings that pick up on “higher level” concepts rather than “low level” textures. So, for example, if we wish to pick up on basic fabric textures we might pull from near the input, and if we wish to pick up something higher level like silhouette type we might pull from deeper in the network.</p><p>The filtering step before we generate a index is also critically important. At this point we can narrow down our products to only come from one particular category, or even some further sub-categorization to leverage the deep knowledge of fashion present at HBC.</p><p>Finally, we must select the parameters for the index generation, which control the error rate and performance trade-off in the approximate nearest neighbors search. We can select these parameters empirically. We utilize our knowledge of fashion, once again, to determine a good operation point.</p><h2 id="whats-next">What’s next?</h2><p>We’ll be working to roll out to more and more categories, and even do some cross category elements, perhaps completing outfits based on their visual compatibility.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">machine learning</span><span>,</span> <span class="article-tags__tag">deep learning</span><span>,</span> <span class="article-tags__tag">personalization</span><span>,</span> <span class="article-tags__tag">recommendation</span></div><section class="author"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Chris Curro</span></section></footer></section></article><aside class="recirc"><h2 class="header__title">More Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">Explore Categories</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree">Dublin Scala Spree</a></h1><div class="snippet__meta"><span class="meta__day">11</span> <span class="meta__month">SEP</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#open source">open source</a>Gregor Heine</div><a href="https://saksdirect.github.io/hbc-tech-blog/open%20source/2017/09/11/dublin-scala-spree/" class="snippet__link" title="Dublin Scala Spree"><p class="snippet__excerpt">Dublin Scala Spree This Friday the Gilt/HBC Digital Dublin office will be hosting the first ever Dublin Scala Spree, a day-long Scala Open Source Hackathon. The event is organized by the Dublin Scala Usergroup in cooperation with Dublin Functional Kubs and the Scala Center at EPFL in Lausanne, Switzerland. Date &amp; Time: Friday, 15th September, 10am - 4pm Location: Gilt/HBC Digital Office, Shelbourne Rd., Dublin 4, Ireland Sign-Up: Please register...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017">HBC Tech Talks: February 2017 through July 2017</a></h1><div class="snippet__meta"><span class="meta__day">10</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/conferences">conferences</a><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/hbc-tech">HBC Tech</a></div><a href="https://saksdirect.github.io/hbc-tech-blog/conferences/2017/08/10/midyear-recap/" class="snippet__link" title="HBC Tech Talks: February 2017 through July 2017"><p class="snippet__excerpt">We’ve had a busy 2017 at HBC. The great work of our teams has created opportunities to share what we’ve learned with audiences around the world. This year our folks have been on stage in Austin, Sydney, Portland, Seattle, San Diego, Boston, London, Israel and on our home turf in NYC and Dublin. The talks have covered deep learning, design thinking, data streaming and developer experience to name just a...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?">Sundial or AWS Batch, Why not both?</a></h1><div class="snippet__meta"><span class="meta__day">4</span> <span class="meta__month">AUG</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#data">data</a>Kevin O'Riordan</div><a href="https://saksdirect.github.io/hbc-tech-blog/data/2017/08/04/sundial-batch/" class="snippet__link" title="Sundial or AWS Batch, Why not both?"><p class="snippet__excerpt">About a year ago, we (the Gilt/HBC personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><a href="https://saksdirect.github.io/hbc-tech-blog/agile/2017/07/27/large-scale-retro/"></a><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/agile/2017/07/27/large-scale-retro/" class="snippet__link" title="How Large Is YOUR Retrospective?">How Large Is YOUR Retrospective?</a></h1><div class="snippet__meta"><span class="meta__day">27</span> <span class="meta__month">JUL</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/#agile">agile</a><a class="meta__author-link" href="https://saksdirect.github.io/hbc-tech-blog/authors/dana-pylayeva">Dana Pylayeva</a><span class="meta__author-job-title">, Senior Developer</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/agile/2017/07/27/large-scale-retro/" class="snippet__link" title="How Large Is YOUR Retrospective?"><p class="snippet__excerpt">Can you recall the size and length of your typical retrospective? If your team operates by The Scrum Guide, your retrospectives likely have less than ten people in one room and last about an hour for a two-weeks Sprint.</p></a></section></article></div></aside></section><footer class="footer"><svg class="hbc-stripes-logo" xmlns="http://www.w3.org/2000/svg"><use class="hbc-stripe hbc-stripe--green" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-green"></use><use class="hbc-stripe hbc-stripe--red" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-red"></use><use class="hbc-stripe hbc-stripe--yellow" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-yellow"></use><use class="hbc-stripe hbc-stripe--blue" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-blue"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><ul class="navigation navigation--footer"><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/insights" class="navigation__link"><span class="navigation__link-highlight">Insights</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/code" class="navigation__link"><span class="navigation__link-highlight">Code</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/culture" class="navigation__link"><span class="navigation__link-highlight">Culture</span></a></li><li class="navigation__link-item"><a href="https://saksdirect.github.io/hbc-tech-blog/jobs" class="navigation__link"><span class="navigation__link-highlight">Work Here</span></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script></body></html>