<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Codedeploy Notifications as a Service</title><title>Codedeploy Notifications as a Service | HBC Tech</title><meta property="og:title" content="Codedeploy Notifications as a Service"><meta name="author" content="Emerson Loureiro"><meta property="og:locale" content="en_US"><meta name="description" content="After moving our software stack to AWS, some of us here at Gilt have started deploying our services to production using AWS’s Codedeploy. Before that, in a not-so-distant past, we used an in-house tool for deployments - IonCannon. One of the things IonCannon provided were deployment notifications. In particular, it would:"><meta property="og:description" content="After moving our software stack to AWS, some of us here at Gilt have started deploying our services to production using AWS’s Codedeploy. Before that, in a not-so-distant past, we used an in-house tool for deployments - IonCannon. One of the things IonCannon provided were deployment notifications. In particular, it would:"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2016-02-10-codedeploy-notifications.html"><meta property="og:url" content="https://saksdirect.github.io/hbc-tech-blog/2016-02-10-codedeploy-notifications.html"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-02-10T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Emerson Loureiro"><script type="application/ld+json">{"name":null,"description":"After moving our software stack to AWS, some of us here at Gilt have started deploying our services to production using AWS’s Codedeploy. Before that, in a not-so-distant past, we used an in-house tool for deployments - IonCannon. One of the things IonCannon provided were deployment notifications. In particular, it would:","author":{"@type":"Person","name":"Emerson Loureiro"},"@type":"BlogPosting","url":"https://saksdirect.github.io/hbc-tech-blog/2016-02-10-codedeploy-notifications.html","publisher":null,"image":null,"headline":"Codedeploy Notifications as a Service","dateModified":"2016-02-10T00:00:00-05:00","datePublished":"2016-02-10T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"https://saksdirect.github.io/hbc-tech-blog/2016-02-10-codedeploy-notifications.html"},"@context":"http://schema.org"}</script><link rel="stylesheet" href="https://saksdirect.github.io/hbc-tech-blog/assets/css/main.css"><link rel="canonical" href="https://saksdirect.github.io/hbc-tech-blog/2016-02-10-codedeploy-notifications.html"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="https://saksdirect.github.io/hbc-tech-blog/assets/images/favicon.ico"></head><body aria-label="Content"><header id="site-header" class="site-header--sub-page"><a class="site-header__logo" href="https://saksdirect.github.io/hbc-tech-blog/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 64 52"><use class="hbc-tech-logo__text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><p class="sticky-nav-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure" class="meta__category">infrastructure</a> <span class="meta__title">Codedeploy Notifications as a Service</span></p><nav class="navigation"><a href="https://saksdirect.github.io/hbc-tech-blog/" class="navigation__link"><svg class="navigation__link__svg-icon" xmlns="http://www.w3.org/2000/svg"><path class="bar bar__top" d="M0,3 L30,3"></path><path class="bar bar__middle" d="M0,14 L30,14"></path><path class="bar bar__bottom" d="M0,25 L30,25"></path></svg></a></nav></header><section class="content"><article class="page article"><section class="article__content"><div class="article-meta"><a href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure" class="article-meta__category">infrastructure</a> <span class="article-meta__date">Published 10 FEB 2016</span></div><h1 class="article__content__title" title="Codedeploy Notifications as a Service">Codedeploy Notifications as a Service</h1><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">7 mins</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=https://saksdirect.github.io/hbc-tech-blog//2016-02-10-codedeploy-notifications.html" class="share-buttons__link" title="Share on Twitter"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://saksdirect.github.io/hbc-tech-blog/&source=/2016-02-10-codedeploy-notifications.html&title=Codedeploy Notifications as a Service" class="share-buttons__link" title="Share on Linkedin"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://saksdirect.github.io/hbc-tech-blog//2016-02-10-codedeploy-notifications.html" class="share-buttons__link" title="Share on Facebook"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=https://saksdirect.github.io/hbc-tech-blog//2016-02-10-codedeploy-notifications.html" class="share-buttons__link" title="Share on Reddit"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><p>After moving our software stack to AWS, some of us here at Gilt have started deploying our services to production using <a href="https://aws.amazon.com/documentation/codedeploy/">AWS’s Codedeploy</a>. Before that, in a not-so-distant past, we used an in-house tool for deployments - IonCannon. One of the things IonCannon provided were deployment notifications. In particular, it would:</p><ol><li>Send an email to the developer who pushed the deployment, for successful and failed deployments;</li><li>Send a new deployment notification to Newrelic;</li><li>Optionally, send a Hipchat message to a pre-configured room, also for successful and failed deployments.</li></ol><p>These notifications had a few advantages.</p><ol><li>If you - like me - prefer to switch to something else while the deployment is ongoing, you would probably want to be notified when it is finished; i.e., “don’t call me, I’ll call you”-sort of thing. The email notifications were a good fit for that;</li><li>Having notifications sent via more open channels, like Newrelic and Hipchat, meant that anyone in the team - or in the company really - could quickly check when a given service was released, which version was released, whether it was out on a canary or all production nodes, etc. In Newrelic, in particular, one can see for example, all deployments for a given time range and filter out errors based on specific deployments. These can come in handy when trying to identify a potentially broken release.</li></ol><p>Codedeploy, however, doesn’t provide anything out-of-the-box for deployment notifications. With that in mind, we have started looking at the different options available to achieve that. For example, AWS itself has the necessary components to get that working - e.g., SNS topics, Codedeploy hooks - but that means you have to do the gluing between your application and those components yourself and, with Codedeploy hooks in particular, on an application-by-application basis. Initially, what some of us have done was a really simple Newrelic deployment notification, by hitting Newrelic’s deployment API in the Codedeploy healthcheck script. This approach worked well for <strong>successful</strong> deployments. Because the healthcheck script is the last hook called by Codedeploy, it was safe to assume the deployment was successful. It was also good for realtime purposes, i.e., the deployment notification would be triggered at the same as the deployment itself.</p><p>Despite that, one can easily think of more complicated workflows. For example, let’s say I want to notify on failed deployments now. Since a failure can happen at any stage of the deployment, the healthcheck hook will not even be called in those cases. Apart from failed deployments, it’s reasonable to think about notifications via email, SNS topics, and so on. All of that essentially means adding various logic to different Codedeploy hooks, triggering the notifications “manually” from there - which for things like sending an email isn’t as simple as hitting an endpoint. Duplication of that logic across different services is then inevitable. An alternative to that would be Cloudtrail and a Lambda. However, given the delay for delivering Cloudtrail log files to S3, we would lose too much on the realtime aspect of the notifications. One good aspect of this approach, though, is that it could handle different applications with a single Lambda.</p><p>So, the ideal approach here would be one that could deliver realtime notifications - or as close to that as possible - and handle multiple Codedeploy applications. Given that, the solution we have been using to some extent here at Gilt is to provide deployment notifications in a configurable way, as a service, by talking directly to Codedeploy. Below is a high-level view of our solution. In essence, our codedeploy notifications service gets deployments directly from Codedeploy and relies on a number of different channels - e.g., SNS, SES, Newrelic, Hipchat - for sending out deployment notifications. These channels are implemented and plugged in as we need though, so not really part of the core of our service. Dynamo DB is used for persisting registrations - more on that below - and successful notifications - to prevent duplications.</p><p><img src="http://i.imgur.com/iiRM48O.png" alt="fancy highlevel view" class="center" style="width: 700px;"></p><p>We have decided to require explicit <em>registration</em> for any application that we would want to have deployment notifications. There are two reasons for doing this. First, our service runs in an account where different applications - from different teams - are running, so we wanted the ability to select which of those would have deployment notifications triggered. Second, as part of registering the application, we wanted the ability to define over which channels those notifications would be triggered. So our service provides an endpoint that takes care of registering a Codedeploy application. Here’s what a request to this endpoint look like.</p><div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -H <span class="s1">'Content-type: application/json'</span> -X POST -d <span class="s1">'{ "codedeploy_application_name": "CODE_DEPLOY_APPLICATION_NAME", "notifications": [ { "newrelic_notification": { "application_name": "NEWRELIC_APPLICATION_NAME" } } ] }'</span> <span class="s1">'http://localhost:9000/registrations'</span>
</code></pre></div><p>This will register a Codedeploy application and set it up for Newrelic notifications. The Codedeploy application name -<code class="highlighter-rouge">CODE_DEPLOY_APPLICATION_NAME</code> above - is used for fetching deployments, so it needs to be the exact name of the application in Codedeploy. The Newrelic application name - <code class="highlighter-rouge">NEWRELIC_APPLICATION_NAME</code> - on the other hand, is used to tell Newrelic which application the deployment notification belongs to. Even though we have only illustrated a single channel above, multiple ones can be provided, each always containing setup specific to that channel - e.g., SMTP server for Emails, topic name for SNS.</p><p>For each registered application, the service then queries Codedeploy for all deployments across all of their deployment groups, for a given time window. Any deployment marked as successful will have a notification triggered over all channels configured for that application. Each successful notification is then saved in Dynamo. That’s done on scheduled-basis - i.e., every time a pre-configured amount of time passes the service checks again for deployments. This means we can make the deployment notifications as realtime as possible, by just adjusting the scheduling frequency.</p><p>Our idea of a notification channel is completely generic. In other words, it’s independent with regards to the reason behind the notification. In that sense, it would be perfectly possible to register Newrelic notifications for failed deployments - even though in practical terms it would be a bit of nonsense, given Newrelic notifications are meant for successful deployments only. We leave it up to those registering their applications to make sure the setup is sound.</p><p>Even though we have talked about a single service doing all of the above, our solution, in fact, is split into two projects. One is a library - codedeploy-notifications - which provides an API for adding registrations, listing Codedeploy deployments, and triggering notifications. The service is then separate, simply integrating with the library. For example, for the registration endpoint we described above, the service uses the following API from codedeploy-notifications under the hood.</p><div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">amazonDynamoClient</span> <span class="k">=</span> <span class="o">...</span>
<span class="k">val</span> <span class="n">registrationDao</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoDbRegistrationDao</span><span class="o">(</span><span class="n">amazonDynamoClient</span><span class="o">)</span>
<span class="k">val</span> <span class="n">newRelicNotificationSetup</span> <span class="k">=</span> <span class="nc">NewrelicNotificationSetup</span><span class="o">(</span><span class="s">"NewrelicApplicationName"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">newRegistration</span> <span class="k">=</span> <span class="nc">NewRegistration</span><span class="o">(</span><span class="s">"CodedeployApplicationName"</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">newRelicNotificationSetup</span><span class="o">))</span>
<span class="n">registrationDao</span><span class="o">.</span><span class="n">newRegistration</span><span class="o">(</span><span class="n">newRegistration</span><span class="o">)</span>
</code></pre></div><p>Splitting things this way means that the library - being free from anything Gilt-specific - can be open-sourced much more easily. Also, it gives users the freedom to choose how to integrate with it. Whereas we currently have it integrated with a small dedicated service, on a T2 Nano instance, others may find it better to integrate it with a service responsible for doing multiple things. Even though the service itself isn’t something open-sourcable - as it would contain API keys, passwords, and such - and it’s currently being owned by one team only, it is still generic enough so it can be used by other teams.</p><p>We have been using this approach for some of our Codedeploy applications, and have been quite happy with the results. The notifications are being triggered with minimal delay - within a couple of seconds for the vast majority of the deployments and under 10 seconds in the worst-case scenarios. The codedeploy-notifications library is open source from day 1 and available <a href="https://github.com/emersonloureiro/codedeploy-notifications">here</a>. It currently supports Newrelic notifications, for successful deployments, and there is current work to support Emails as well as notifications for failed deployments. Suggestions, comments, and contributions are, of course, always welcome.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">aws</span><span>,</span> <span class="article-tags__tag">codedeploy</span><span>,</span> <span class="article-tags__tag">newrelic</span><span>,</span> <span class="article-tags__tag">notifications</span></div><section class="author-bio"><svg class="author__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#body"></use></svg><span class="author__name">Emerson Loureiro</span></section></footer></section><aside class="recirc"><h2 class="header__title">Recent Insights</h2><a class="header__view-all-link" href="https://saksdirect.github.io/hbc-tech-blog/categories/index.html">See All</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2017-01-25-keep-an-eye-on-your-stack-with-cloudwatch-events-lambda.html" class="snippet__title__link" title="Keeping an Extra Eye on Your Stack with CloudWatch Events">Keeping an Extra Eye on Your Stack with CloudWatch Events</a></h1><div class="snippet__meta"><span class="meta__day">25</span> <span class="meta__month">JAN</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure">infrastructure</a> <span class="slug-divider"></span> <span class="meta__author">Emerson Loureiro</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2017-01-25-keep-an-eye-on-your-stack-with-cloudwatch-events-lambda.html" class="snippet__excerpt__link" title="Keeping an Extra Eye on Your Stack with CloudWatch Events"><p class="snippet__excerpt">Why an Extra Eye?</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2017-05-19-cloudformation-nanoservice.html" class="snippet__title__link" title="CloudFormation Nanoservice">CloudFormation Nanoservice</a></h1><div class="snippet__meta"><span class="meta__day">19</span> <span class="meta__month">MAY</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure">infrastructure</a> <span class="slug-divider"></span> <span class="meta__author">Ryan Martin</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2017-05-19-cloudformation-nanoservice.html" class="snippet__excerpt__link" title="CloudFormation Nanoservice"><p class="snippet__excerpt">One of the big HBC Digital initiatives for 2017 is “buy online, pickup in store” - somewhat awkwardly nicknamed “BOPIS” internally. This is the option for the customer to, instead of shipping an order to an address, pick it up in a store that has the items in inventory.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2017-02-06-sundial-pagerduty-integration.html" class="snippet__title__link" title="Sundial PagerDuty Integration">Sundial PagerDuty Integration</a></h1><div class="snippet__meta"><span class="meta__day">6</span> <span class="meta__month">FEB</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure">infrastructure</a> <span class="slug-divider"></span> <span class="meta__author">Giovanni Gargiulo</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2017-02-06-sundial-pagerduty-integration.html" class="snippet__excerpt__link" title="Sundial PagerDuty Integration"><p class="snippet__excerpt">Sundial</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="https://saksdirect.github.io/hbc-tech-blog/2017-01-25-keep-an-eye-on-your-stack-with-cloudwatch-events-lambda.html" class="snippet__title__link" title="Keeping an Extra Eye on Your Stack with CloudWatch Events">Keeping an Extra Eye on Your Stack with CloudWatch Events</a></h1><div class="snippet__meta"><span class="meta__day">25</span> <span class="meta__month">JAN</span> <span class="meta__year">2017</span> <a class="meta__category-link" href="https://saksdirect.github.io/hbc-tech-blog/category/infrastructure">infrastructure</a> <span class="slug-divider"></span> <span class="meta__author">Emerson Loureiro</span></div><a href="https://saksdirect.github.io/hbc-tech-blog/2017-01-25-keep-an-eye-on-your-stack-with-cloudwatch-events-lambda.html" class="snippet__excerpt__link" title="Keeping an Extra Eye on Your Stack with CloudWatch Events"><p class="snippet__excerpt">Why an Extra Eye?</p></a></section></article></div></aside></article></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" rel="next" href="#"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://saksdirect.github.io/hbc-tech-blog/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><p class="copyright">&copy; 2017 HBC Tech</p></section></footer><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/vendor/scrollmagic/debug.addIndicators.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/main.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script type="text/javascript" src="https://saksdirect.github.io/hbc-tech-blog/assets/js/get-gh-repos.js"></script></body></html>